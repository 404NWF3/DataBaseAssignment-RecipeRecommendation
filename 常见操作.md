# 第5章 常见操作归纳

本章列举数据库的日常操作，分为查询、插入、更新、删除四大类，共涵盖 **40+ 个实际应用场景**。

## 5.1 查询操作（SELECT）

| 类别 | 操作名称 | 描述/目的 |
| :--- | :--- | :--- |
| **基础查询** | 按菜系搜索食谱 | 根据菜系、发布状态筛选食谱，按评分和浏览量排序 |
| | 按难度和时间查询食谱 | 筛选特定难度和时间限制内的食谱 |
| | 查询用户的所有食谱 | 获取指定用户发布的所有未删除食谱 |
| | 查询用户收藏的食谱 | 获取指定用户收藏的食谱列表 |
| **复杂关联查询** | 查询食谱详情 | 获取食谱的基本信息、作者、营养成分及标签等完整详情 |
| | 查询食谱食材 | 列出食谱所需的所有食材、用量及单位 |
| | 查询烹饪步骤 | 按顺序获取食谱的制作步骤和图片 |
| **评价与评论** | 查询食谱评价 | 获取食谱的评分、评论内容及有用性计数 |
| | 查询食谱评论 | 递归查询食谱的评论树（含回复） |
| | 查询用户评价 | 获取指定用户发出的所有评价记录 |
| **社交与推荐** | 查询关注/粉丝 | 获取用户的关注列表和粉丝列表 |
| | 关注者食谱推荐 | 推荐用户关注的创作者发布的新食谱 |
| | 特定食材搜索 | 查找包含指定食材（如鸡蛋、面粉）的食谱 |
| | 安全食谱推荐 | 排除用户过敏食材的食谱推荐 |
| **高级分析** | 热门食谱排行 | 基于评分、评论数、浏览数计算热度并排行 |
| | 生成购物清单 | 根据膳食计划自动汇总所需食材清单 |
| | 查询食材替代品 | 查找指定食材的已批准替代品及比例 |
| | 热门食材搭配 | 分析高分食谱中常见的食材组合 |

## 5.2 数据变更操作（INSERT/UPDATE/DELETE）

| 操作类型 | 类别 | 操作名称 | 描述/目的 |
| :--- | :--- | :--- | :--- |
| **插入 (INSERT)** | 用户与食谱 | 新用户注册 | 创建新的用户账户信息 |
| | | 发布新食谱 | 事务处理：插入食谱、食材、步骤、营养信息并记录日志 |
| | 交互 | 用户评价/评论 | 添加评分、评论内容，并更新统计数据 |
| | | 收藏食谱 | 将食谱添加到用户收藏夹 |
| | | 关注用户 | 建立用户间的关注关系 |
| | | 点赞有用 | 标记评价或评论为“有用” |
| | 计划与清单 | 创建膳食计划 | 建立新的膳食计划记录 |
| | | 添加计划项 | 向膳食计划中添加食谱 |
| | | 创建购物清单 | 生成清单并自动导入计划所需的食材 |
| | 设置 | 添加过敏原 | 记录用户的过敏食材信息 |
| **更新 (UPDATE)** | 编辑 | 更新食谱信息 | 修改食谱详情及更新时间 |
| | | 逻辑删除 | 将食谱或评论标记为删除状态（保留数据） |
| | 状态 | 禁用账户 | 修改用户账户状态为挂起 |
| | | 购物清单勾选 | 标记清单中的物品为已购买 |
| **删除 (DELETE)** | 清理 | 删除评价/收藏 | 物理删除评价记录或取消收藏 |
| | | 清空购物清单 | 删除指定清单内的所有条目 |
| | | 取消关注 | 移除关注关系 |
| | | 撤销投票 | 取消对评价/评论的“有用”标记 |
| | | 移除过敏原 | 删除用户的过敏记录 |

---

# 第6章 完整性约束方案设计

完整性约束是数据库的守护者，确保数据的准确性、一致性和可靠性。

## 6.1 实体完整性

**定义**：每个表都有唯一的主键，确保记录的唯一性。

**实现**：
```sql
-- 主键约束示例
ALTER TABLE USERS ADD CONSTRAINT pk_users PRIMARY KEY (user_id);
ALTER TABLE RECIPES ADD CONSTRAINT pk_recipes PRIMARY KEY (recipe_id);
ALTER TABLE RATINGS ADD CONSTRAINT pk_ratings PRIMARY KEY (rating_id);
-- ... （所有表都有类似约束）
```

**验证**：
```sql
-- 插入重复主键时将失败
INSERT INTO USERS VALUES (1, 'user1', ...);
INSERT INTO USERS VALUES (1, 'user2', ...);  -- 错误：违反主键约束
```
